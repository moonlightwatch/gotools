package stream_test

import (
	"bytes"
	"compress/gzip"
	"io"
	"strings"
	"testing"

	"github.com/moonlightwatch/gotools/stream"
)

func TestReplace(t *testing.T) {
	var tests = []struct {
		input    string
		old      []byte
		new      []byte
		expected string
	}{
		{"hello", []byte("l"), []byte("L"), "heLLo"},
		{"abcdefghigklmnopqrstuvwxyz", []byte("l"), []byte("L"), "abcdefghigkLmnopqrstuvwxyz"},
		{"hello", []byte("l"), []byte("LL"), "heLLLLo"},
		{"hello", []byte("admin"), []byte("LL"), "hello"},
		{"hello", []byte("llllllllll"), []byte("LL"), "hello"},
		{"hello", []byte("ho"), []byte("LL"), "hello"},
		{"hello", []byte("ll"), []byte("LL"), "heLLo"},
		{"heallo", []byte("ll"), []byte("LL"), "heaLLo"},
		{"healllo", []byte("ll"), []byte("LL"), "heaLLlo"},
		{"heallllo", []byte("ll"), []byte("LL"), "heaLLLLo"},
		{"heallllo", []byte("lll"), []byte("LL"), "heaLLlo"},
		{"hello", []byte("lo"), []byte("LL"), "helLL"},
		{"helloooo", []byte("oo"), []byte("LL"), "hellLLLL"},
		{"hellooo", []byte("oo"), []byte("LL"), "hellLLo"},
		{"hellooooo", []byte("oo"), []byte("LL"), "hellLLLLo"},
		{"hello", []byte("hello"), []byte("admin"), "admin"},
		{"hello", []byte("h"), []byte("admin"), "adminello"},
		{"hello", []byte("hellohello"), []byte("admin"), "hello"},
		{"hellohello", []byte("hello"), []byte("admin"), "adminadmin"},
	}

	for _, test := range tests {
		reader := bytes.NewBufferString(test.input)
		writer := strings.Builder{}
		err := stream.Replace(reader, &writer, []byte(test.old), []byte(test.new))
		if err != nil {
			t.Errorf("Replace(%s, %s, %s): expected %v, actual %v", test.input, test.old, test.new, nil, err)
		}
		if writer.String() != test.expected {
			t.Errorf("Replace(%s, %s, %s): expected %v, actual %v", test.input, test.old, test.new, test.expected, writer.String())
		}
	}
}

func TestReplaceBig(t *testing.T) {
	s := `æ´›ç¥èµ‹

    ä½œè€…ï¼šæ›¹æ¤
    æœä»£ï¼šé­æ™‹

é»„åˆä¸‰å¹´ï¼Œä½™æœäº¬å¸ˆï¼Œè¿˜æµæ´›å·ã€‚å¤äººæœ‰è¨€ï¼Œæ–¯æ°´ä¹‹ç¥ï¼Œåæ›°å®“å¦ƒã€‚æ„Ÿå®‹ç‰å¯¹æ¥šç‹ç¥å¥³ä¹‹äº‹ï¼Œé‚ä½œæ–¯èµ‹ã€‚å…¶è¾æ›°ï¼š

ä½™ä»äº¬åŸŸï¼Œè¨€å½’ä¸œè—©ã€‚èƒŒä¼Šé˜™ï¼Œè¶Šè½˜è¾•ï¼Œç»é€šè°·ï¼Œé™µæ™¯å±±ã€‚æ—¥æ—¢è¥¿å€¾ï¼Œè½¦æ®†é©¬çƒ¦ã€‚å°”ä¹ƒç¨é©¾ä¹è˜…çš‹ï¼Œç§£é©·ä¹èŠç”°ï¼Œå®¹ä¸ä¹é˜³æ—ï¼Œæµçœ„ä¹æ´›å·ã€‚äºæ˜¯ç²¾ç§»ç¥éª‡ï¼Œå¿½ç„‰æ€æ•£ã€‚ä¿¯åˆ™æœªå¯Ÿï¼Œä»°ä»¥æ®Šè§‚ï¼Œç¹ä¸€ä¸½äººï¼Œäºå²©ä¹‹ç•”ã€‚ä¹ƒæ´å¾¡è€…è€Œå‘Šä¹‹æ›°ï¼šâ€œå°”æœ‰è§Œäºå½¼è€…ä¹ï¼Ÿå½¼ä½•äººæ–¯ï¼Ÿè‹¥æ­¤ä¹‹è‰³ä¹Ÿï¼â€å¾¡è€…å¯¹æ›°ï¼šâ€œè‡£é—»æ²³æ´›ä¹‹ç¥ï¼Œåæ›°å®“å¦ƒã€‚ç„¶åˆ™å›ç‹æ‰€è§ï¼Œæ— ä¹ƒæ˜¯ä¹ï¼Ÿå…¶çŠ¶è‹¥ä½•ï¼Ÿè‡£æ„¿é—»ä¹‹ã€‚â€

ä½™å‘Šä¹‹æ›°ï¼šå…¶å½¢ä¹Ÿï¼Œç¿©è‹¥æƒŠé¸¿ï¼Œå©‰è‹¥æ¸¸é¾™ã€‚è£æ›œç§‹èŠï¼ŒåèŒ‚æ˜¥æ¾ã€‚é«£é«´å…®è‹¥è½»äº‘ä¹‹è”½æœˆï¼Œé£˜é£–å…®è‹¥æµé£ä¹‹å›é›ªã€‚è¿œè€Œæœ›ä¹‹ï¼Œçšè‹¥å¤ªé˜³å‡æœéœï¼›è¿«è€Œå¯Ÿä¹‹ï¼Œç¼è‹¥èŠ™è•–å‡ºæ¸Œæ³¢ã€‚ç§¾çº¤å¾—è¡·ï¼Œä¿®çŸ­åˆåº¦ã€‚è‚©è‹¥å‰Šæˆï¼Œè…°å¦‚çº¦ç´ ã€‚å»¶é¢ˆç§€é¡¹ï¼Œçš“è´¨å‘ˆéœ²ã€‚èŠ³æ³½æ— åŠ ï¼Œé“…åå¼—å¾¡ã€‚äº‘é«»å³¨å³¨ï¼Œä¿®çœ‰è”å¨Ÿã€‚ä¸¹å”‡å¤–æœ—ï¼Œçš“é½¿å†…é²œï¼Œæ˜çœ¸å–„çï¼Œé¥è¾…æ‰¿æƒã€‚ç‘°å§¿è‰³é€¸ï¼Œä»ªé™ä½“é—²ã€‚æŸ”æƒ…ç»°æ€ï¼Œåªšäºè¯­è¨€ã€‚å¥‡æœæ—·ä¸–ï¼Œéª¨åƒåº”å›¾ã€‚æŠ«ç½—è¡£ä¹‹ç’€ç²²å…®ï¼Œç¥ç‘¶ç¢§ä¹‹åçšã€‚æˆ´é‡‘ç¿ ä¹‹é¦–é¥°ï¼Œç¼€æ˜ç ä»¥è€€èº¯ã€‚è·µè¿œæ¸¸ä¹‹æ–‡å±¥ï¼Œæ›³é›¾ç»¡ä¹‹è½»è£¾ã€‚å¾®å¹½å…°ä¹‹èŠ³è”¼å…®ï¼Œæ­¥è¸Ÿè¹°äºå±±éš…ã€‚

äºæ˜¯å¿½ç„‰çºµä½“ï¼Œä»¥é¨ä»¥å¬‰ã€‚å·¦å€šé‡‡æ—„ï¼Œå³è«æ¡‚æ——ã€‚å£¤çš“è…•äºç¥æµ’å…®ï¼Œé‡‡æ¹æ¿‘ä¹‹ç„èŠã€‚ä½™æƒ…æ‚¦å…¶æ·‘ç¾å…®ï¼Œå¿ƒæŒ¯è¡è€Œä¸æ€¡ã€‚æ— è‰¯åª’ä»¥æ¥æ¬¢å…®ï¼Œæ‰˜å¾®æ³¢è€Œé€šè¾ã€‚æ„¿è¯šç´ ä¹‹å…ˆè¾¾å…®ï¼Œè§£ç‰ä½©ä»¥è¦ä¹‹ã€‚å—Ÿä½³äººä¹‹ä¿¡ä¿®ï¼Œç¾Œä¹ ç¤¼è€Œæ˜è¯—ã€‚æŠ—ç¼ç¶ä»¥å’Œäºˆå…®ï¼ŒæŒ‡æ½œæ¸Šè€Œä¸ºæœŸã€‚æ‰§çœ·çœ·ä¹‹æ¬¾å®å…®ï¼Œæƒ§æ–¯çµä¹‹æˆ‘æ¬ºã€‚æ„Ÿäº¤ç”«ä¹‹å¼ƒè¨€å…®ï¼Œæ€…çŠ¹è±«è€Œç‹ç–‘ã€‚æ”¶å’Œé¢œè€Œé™å¿—å…®ï¼Œç”³ç¤¼é˜²ä»¥è‡ªæŒã€‚

äºæ˜¯æ´›çµæ„Ÿç„‰ï¼Œå¾™å€šå½·å¾¨ï¼Œç¥å…‰ç¦»åˆï¼Œä¹é˜´ä¹é˜³ã€‚ç«¦è½»èº¯ä»¥é¹¤ç«‹ï¼Œè‹¥å°†é£è€Œæœªç¿”ã€‚è·µæ¤’æ¶‚ä¹‹éƒçƒˆï¼Œæ­¥è˜…è–„è€ŒæµèŠ³ã€‚è¶…é•¿åŸä»¥æ°¸æ…•å…®ï¼Œå£°å“€å‰è€Œå¼¥é•¿ã€‚

å°”ä¹ƒä¼—çµæ‚æ²“ï¼Œå‘½ä¿¦å•¸ä¾£ï¼Œæˆ–æˆæ¸…æµï¼Œæˆ–ç¿”ç¥æ¸šï¼Œæˆ–é‡‡æ˜ç ï¼Œæˆ–æ‹¾ç¿ ç¾½ã€‚ä»å—æ¹˜ä¹‹äºŒå¦ƒï¼Œæºæ±‰æ»¨ä¹‹æ¸¸å¥³ã€‚å¹åŒç“œä¹‹æ— åŒ¹å…®ï¼Œå’ç‰µç‰›ä¹‹ç‹¬å¤„ã€‚æ‰¬è½»è¢¿ä¹‹çŒ—é¡å…®ï¼Œç¿³ä¿®è¢–ä»¥å»¶ä¼«ã€‚ä½“è¿…é£å‡«ï¼Œé£˜å¿½è‹¥ç¥ï¼Œå‡Œæ³¢å¾®æ­¥ï¼Œç½—è¢œç”Ÿå°˜ã€‚åŠ¨æ— å¸¸åˆ™ï¼Œè‹¥å±è‹¥å®‰ã€‚è¿›æ­¢éš¾æœŸï¼Œè‹¥å¾€è‹¥è¿˜ã€‚è½¬çœ„æµç²¾ï¼Œå…‰æ¶¦ç‰é¢œã€‚å«è¾æœªåï¼Œæ°”è‹¥å¹½å…°ã€‚åå®¹å©€å¨œï¼Œä»¤æˆ‘å¿˜é¤ã€‚

äºæ˜¯å±ç¿³æ”¶é£ï¼Œå·åé™æ³¢ã€‚å†¯å¤·é¸£é¼“ï¼Œå¥³å¨²æ¸…æ­Œã€‚è…¾æ–‡é±¼ä»¥è­¦ä¹˜ï¼Œé¸£ç‰é¸¾ä»¥å•é€ã€‚å…­é¾™ä¿¨å…¶é½é¦–ï¼Œè½½äº‘è½¦ä¹‹å®¹è£”ï¼Œé²¸é²µè¸Šè€Œå¤¹æ¯‚ï¼Œæ°´ç¦½ç¿”è€Œä¸ºå«ã€‚

äºæ˜¯è¶ŠåŒ—æ²šã€‚è¿‡å—å†ˆï¼Œçº¡ç´ é¢†ï¼Œå›æ¸…é˜³ï¼ŒåŠ¨æœ±å”‡ä»¥å¾è¨€ï¼Œé™ˆäº¤æ¥ä¹‹å¤§çº²ã€‚æ¨äººç¥ä¹‹é“æ®Šå…®ï¼Œæ€¨ç››å¹´ä¹‹è«å½“ã€‚æŠ—ç½—è¢‚ä»¥æ©æ¶•å…®ï¼Œæ³ªæµè¥Ÿä¹‹æµªæµªã€‚æ‚¼è‰¯ä¼šä¹‹æ°¸ç»å…®ï¼Œå“€ä¸€é€è€Œå¼‚ä¹¡ã€‚æ— å¾®æƒ…ä»¥æ•ˆçˆ±å…®ï¼ŒçŒ®æ±Ÿå—ä¹‹æ˜ç°ã€‚è™½æ½œå¤„äºå¤ªé˜´ï¼Œé•¿å¯„å¿ƒäºå›ç‹ã€‚å¿½ä¸æ‚Ÿå…¶æ‰€èˆï¼Œæ€…ç¥å®µè€Œè”½å…‰ã€‚

äºæ˜¯èƒŒä¸‹é™µé«˜ï¼Œè¶³å¾€ç¥ç•™ï¼Œé—æƒ…æƒ³åƒï¼Œé¡¾æœ›æ€€æ„ã€‚å†€çµä½“ä¹‹å¤å½¢ï¼Œå¾¡è½»èˆŸè€Œä¸Šæº¯ã€‚æµ®é•¿å·è€Œå¿˜è¿”ï¼Œæ€ç»µç»µè€Œå¢æ…•ã€‚å¤œè€¿è€¿è€Œä¸å¯ï¼Œæ²¾ç¹éœœè€Œè‡³æ›™ã€‚å‘½ä»†å¤«è€Œå°±é©¾ï¼Œå¾å°†å½’ä¹ä¸œè·¯ã€‚æ½é¨‘è¾”ä»¥æŠ—ç­–ï¼Œæ€…ç›˜æ¡“è€Œä¸èƒ½å»ã€‚
`
	d := `æ´›ç¥èµ‹

    ä½œè€…ï¼šæ›¹æ¤
    æœä»£ï¼šé­æ™‹

é»„åˆä¸‰å¹´ï¼Œä½™æœäº¬å¸ˆï¼Œè¿˜æµæ´›å·ã€‚å¤äººæœ‰è¨€ï¼Œæ–¯æ°´ä¹‹ç¥ï¼Œåæ›°å®“å¦ƒã€‚æ„Ÿå®‹ç‰å¯¹æ¥šç‹ç¥å¥³ä¹‹äº‹ï¼Œé‚ä½œæ–¯èµ‹ã€‚å…¶è¾æ›°ï¼š

ä½™ä»äº¬åŸŸï¼Œè¨€å½’ä¸œè—©ã€‚èƒŒä¼Šé˜™ï¼Œè¶Šè½˜è¾•ï¼Œç»é€šè°·ï¼Œé™µæ™¯å±±ã€‚æ—¥æ—¢è¥¿å€¾ï¼Œè½¦æ®†é©¬çƒ¦ã€‚å°”ä¹ƒç¨é©¾ä¹è˜…çš‹ï¼Œç§£é©·ä¹èŠç”°ï¼Œå®¹ä¸ä¹é˜³æ—ï¼Œæµçœ„ä¹æ´›å·ã€‚äºæ˜¯ç²¾ç§»ç¥éª‡ï¼Œå¿½ç„‰æ€æ•£ã€‚ä¿¯åˆ™æœªå¯Ÿï¼Œä»°ä»¥æ®Šè§‚ï¼Œç¹ä¸€ä¸½äººï¼Œäºå²©ä¹‹ç•”ã€‚ä¹ƒæ´å¾¡è€…è€Œå‘Šä¹‹æ›°ï¼šâ€œå°”æœ‰è§Œäºå½¼è€…ä¹ï¼Ÿå½¼ä½•äººæ–¯ï¼Ÿè‹¥æ­¤ä¹‹è‰³ä¹Ÿï¼â€å¾¡è€…å¯¹æ›°ï¼šâ€œè‡£é—»æ²³æ´›ä¹‹ç¥ï¼Œåæ›°å®“å¦ƒã€‚ç„¶åˆ™å›ç‹æ‰€è§ï¼Œæ— ä¹ƒæ˜¯ä¹ï¼Ÿå…¶çŠ¶è‹¥ä½•ï¼Ÿè‡£æ„¿é—»ä¹‹ã€‚â€

ä½™å‘Šä¹‹æ›°ï¼šå…¶å½¢ä¹Ÿï¼ŒXXXXï¼Œå©‰è‹¥æ¸¸é¾™ã€‚è£æ›œç§‹èŠï¼ŒåèŒ‚æ˜¥æ¾ã€‚é«£é«´å…®è‹¥è½»äº‘ä¹‹è”½æœˆï¼Œé£˜é£–å…®è‹¥æµé£ä¹‹å›é›ªã€‚è¿œè€Œæœ›ä¹‹ï¼Œçšè‹¥å¤ªé˜³å‡æœéœï¼›è¿«è€Œå¯Ÿä¹‹ï¼Œç¼è‹¥èŠ™è•–å‡ºæ¸Œæ³¢ã€‚ç§¾çº¤å¾—è¡·ï¼Œä¿®çŸ­åˆåº¦ã€‚è‚©è‹¥å‰Šæˆï¼Œè…°å¦‚çº¦ç´ ã€‚å»¶é¢ˆç§€é¡¹ï¼Œçš“è´¨å‘ˆéœ²ã€‚èŠ³æ³½æ— åŠ ï¼Œé“…åå¼—å¾¡ã€‚äº‘é«»å³¨å³¨ï¼Œä¿®çœ‰è”å¨Ÿã€‚ä¸¹å”‡å¤–æœ—ï¼Œçš“é½¿å†…é²œï¼Œæ˜çœ¸å–„çï¼Œé¥è¾…æ‰¿æƒã€‚ç‘°å§¿è‰³é€¸ï¼Œä»ªé™ä½“é—²ã€‚æŸ”æƒ…ç»°æ€ï¼Œåªšäºè¯­è¨€ã€‚å¥‡æœæ—·ä¸–ï¼Œéª¨åƒåº”å›¾ã€‚æŠ«ç½—è¡£ä¹‹ç’€ç²²å…®ï¼Œç¥ç‘¶ç¢§ä¹‹åçšã€‚æˆ´é‡‘ç¿ ä¹‹é¦–é¥°ï¼Œç¼€æ˜ç ä»¥è€€èº¯ã€‚è·µè¿œæ¸¸ä¹‹æ–‡å±¥ï¼Œæ›³é›¾ç»¡ä¹‹è½»è£¾ã€‚å¾®å¹½å…°ä¹‹èŠ³è”¼å…®ï¼Œæ­¥è¸Ÿè¹°äºå±±éš…ã€‚

äºæ˜¯å¿½ç„‰çºµä½“ï¼Œä»¥é¨ä»¥å¬‰ã€‚å·¦å€šé‡‡æ—„ï¼Œå³è«æ¡‚æ——ã€‚å£¤çš“è…•äºç¥æµ’å…®ï¼Œé‡‡æ¹æ¿‘ä¹‹ç„èŠã€‚ä½™æƒ…æ‚¦å…¶æ·‘ç¾å…®ï¼Œå¿ƒæŒ¯è¡è€Œä¸æ€¡ã€‚æ— è‰¯åª’ä»¥æ¥æ¬¢å…®ï¼Œæ‰˜å¾®æ³¢è€Œé€šè¾ã€‚æ„¿è¯šç´ ä¹‹å…ˆè¾¾å…®ï¼Œè§£ç‰ä½©ä»¥è¦ä¹‹ã€‚å—Ÿä½³äººä¹‹ä¿¡ä¿®ï¼Œç¾Œä¹ ç¤¼è€Œæ˜è¯—ã€‚æŠ—ç¼ç¶ä»¥å’Œäºˆå…®ï¼ŒæŒ‡æ½œæ¸Šè€Œä¸ºæœŸã€‚æ‰§çœ·çœ·ä¹‹æ¬¾å®å…®ï¼Œæƒ§æ–¯çµä¹‹æˆ‘æ¬ºã€‚æ„Ÿäº¤ç”«ä¹‹å¼ƒè¨€å…®ï¼Œæ€…çŠ¹è±«è€Œç‹ç–‘ã€‚æ”¶å’Œé¢œè€Œé™å¿—å…®ï¼Œç”³ç¤¼é˜²ä»¥è‡ªæŒã€‚

äºæ˜¯æ´›çµæ„Ÿç„‰ï¼Œå¾™å€šå½·å¾¨ï¼Œç¥å…‰ç¦»åˆï¼Œä¹é˜´ä¹é˜³ã€‚ç«¦è½»èº¯ä»¥é¹¤ç«‹ï¼Œè‹¥å°†é£è€Œæœªç¿”ã€‚è·µæ¤’æ¶‚ä¹‹éƒçƒˆï¼Œæ­¥è˜…è–„è€ŒæµèŠ³ã€‚è¶…é•¿åŸä»¥æ°¸æ…•å…®ï¼Œå£°å“€å‰è€Œå¼¥é•¿ã€‚

å°”ä¹ƒä¼—çµæ‚æ²“ï¼Œå‘½ä¿¦å•¸ä¾£ï¼Œæˆ–æˆæ¸…æµï¼Œæˆ–ç¿”ç¥æ¸šï¼Œæˆ–é‡‡æ˜ç ï¼Œæˆ–æ‹¾ç¿ ç¾½ã€‚ä»å—æ¹˜ä¹‹äºŒå¦ƒï¼Œæºæ±‰æ»¨ä¹‹æ¸¸å¥³ã€‚å¹åŒç“œä¹‹æ— åŒ¹å…®ï¼Œå’ç‰µç‰›ä¹‹ç‹¬å¤„ã€‚æ‰¬è½»è¢¿ä¹‹çŒ—é¡å…®ï¼Œç¿³ä¿®è¢–ä»¥å»¶ä¼«ã€‚ä½“è¿…é£å‡«ï¼Œé£˜å¿½è‹¥ç¥ï¼Œå‡Œæ³¢å¾®æ­¥ï¼Œç½—è¢œç”Ÿå°˜ã€‚åŠ¨æ— å¸¸åˆ™ï¼Œè‹¥å±è‹¥å®‰ã€‚è¿›æ­¢éš¾æœŸï¼Œè‹¥å¾€è‹¥è¿˜ã€‚è½¬çœ„æµç²¾ï¼Œå…‰æ¶¦ç‰é¢œã€‚å«è¾æœªåï¼Œæ°”è‹¥å¹½å…°ã€‚åå®¹å©€å¨œï¼Œä»¤æˆ‘å¿˜é¤ã€‚

äºæ˜¯å±ç¿³æ”¶é£ï¼Œå·åé™æ³¢ã€‚å†¯å¤·é¸£é¼“ï¼Œå¥³å¨²æ¸…æ­Œã€‚è…¾æ–‡é±¼ä»¥è­¦ä¹˜ï¼Œé¸£ç‰é¸¾ä»¥å•é€ã€‚å…­é¾™ä¿¨å…¶é½é¦–ï¼Œè½½äº‘è½¦ä¹‹å®¹è£”ï¼Œé²¸é²µè¸Šè€Œå¤¹æ¯‚ï¼Œæ°´ç¦½ç¿”è€Œä¸ºå«ã€‚

äºæ˜¯è¶ŠåŒ—æ²šã€‚è¿‡å—å†ˆï¼Œçº¡ç´ é¢†ï¼Œå›æ¸…é˜³ï¼ŒåŠ¨æœ±å”‡ä»¥å¾è¨€ï¼Œé™ˆäº¤æ¥ä¹‹å¤§çº²ã€‚æ¨äººç¥ä¹‹é“æ®Šå…®ï¼Œæ€¨ç››å¹´ä¹‹è«å½“ã€‚æŠ—ç½—è¢‚ä»¥æ©æ¶•å…®ï¼Œæ³ªæµè¥Ÿä¹‹æµªæµªã€‚æ‚¼è‰¯ä¼šä¹‹æ°¸ç»å…®ï¼Œå“€ä¸€é€è€Œå¼‚ä¹¡ã€‚æ— å¾®æƒ…ä»¥æ•ˆçˆ±å…®ï¼ŒçŒ®æ±Ÿå—ä¹‹æ˜ç°ã€‚è™½æ½œå¤„äºå¤ªé˜´ï¼Œé•¿å¯„å¿ƒäºå›ç‹ã€‚å¿½ä¸æ‚Ÿå…¶æ‰€èˆï¼Œæ€…ç¥å®µè€Œè”½å…‰ã€‚

äºæ˜¯èƒŒä¸‹é™µé«˜ï¼Œè¶³å¾€ç¥ç•™ï¼Œé—æƒ…æƒ³åƒï¼Œé¡¾æœ›æ€€æ„ã€‚å†€çµä½“ä¹‹å¤å½¢ï¼Œå¾¡è½»èˆŸè€Œä¸Šæº¯ã€‚æµ®é•¿å·è€Œå¿˜è¿”ï¼Œæ€ç»µç»µè€Œå¢æ…•ã€‚å¤œè€¿è€¿è€Œä¸å¯ï¼Œæ²¾ç¹éœœè€Œè‡³æ›™ã€‚å‘½ä»†å¤«è€Œå°±é©¾ï¼Œå¾å°†å½’ä¹ä¸œè·¯ã€‚æ½é¨‘è¾”ä»¥æŠ—ç­–ï¼Œæ€…ç›˜æ¡“è€Œä¸èƒ½å»ã€‚
`

	{

		reader := strings.NewReader(s)
		writer := strings.Builder{}
		err := stream.Replace(reader, &writer, []byte("ç¿©è‹¥æƒŠé¸¿"), []byte("XXXX"))
		if err != nil {
			t.Errorf("Replace(%s, %s, %s): expected %v, actual %v", s, "ç¿©è‹¥æƒŠé¸¿", "XXXX", nil, err)
		}
		if writer.String() != d {
			t.Errorf("Replace(%s, %s, %s): expected %v, actual %v", s, "ç¿©è‹¥æƒŠé¸¿", "XXXX", d, writer.String())
		}
	}
}

func TestReplaceGzip(t *testing.T) {
	var tests = []struct {
		input    string
		old      []byte
		new      []byte
		expected string
	}{
		{"hello", []byte("l"), []byte("L"), "heLLo"},
		{"abcdefghigklmnopqrstuvwxyz", []byte("l"), []byte("L"), "abcdefghigkLmnopqrstuvwxyz"},
		{"hello", []byte("l"), []byte("LL"), "heLLLLo"},
		{"hello", []byte("admin"), []byte("LL"), "hello"},
		{"hello", []byte("llllllllll"), []byte("LL"), "hello"},
		{"hello", []byte("ho"), []byte("LL"), "hello"},
		{"hello", []byte("ll"), []byte("LL"), "heLLo"},
		{"heallo", []byte("ll"), []byte("LL"), "heaLLo"},
		{"healllo", []byte("ll"), []byte("LL"), "heaLLlo"},
		{"heallllo", []byte("ll"), []byte("LL"), "heaLLLLo"},
		{"heallllo", []byte("lll"), []byte("LL"), "heaLLlo"},
		{"hello", []byte("lo"), []byte("LL"), "helLL"},
		{"helloooo", []byte("oo"), []byte("LL"), "hellLLLL"},
		{"hellooo", []byte("oo"), []byte("LL"), "hellLLo"},
		{"hellooooo", []byte("oo"), []byte("LL"), "hellLLLLo"},
		{"hello", []byte("hello"), []byte("admin"), "admin"},
		{"hello", []byte("h"), []byte("admin"), "adminello"},
		{"hello", []byte("hellohello"), []byte("admin"), "hello"},
		{"hellohello", []byte("hello"), []byte("admin"), "adminadmin"},
	}

	for _, test := range tests {
		var buf bytes.Buffer
		gw := gzip.NewWriter(&buf)
		_, err := gw.Write([]byte(test.input))
		if err != nil {
			t.Errorf("gzip write error: %v", err)
		}
		gw.Flush()
		gw.Close()
		reader := bytes.NewReader(buf.Bytes())
		writer := bytes.Buffer{}
		err = stream.Replace(reader, &writer, []byte(test.old), []byte(test.new))
		if err != nil {
			t.Errorf("ReplaceGzip(%s, %s, %s): expected %v, actual %v", test.input, test.old, test.new, nil, err)
		}

		r, err := gzip.NewReader(bytes.NewReader(writer.Bytes()))
		if err != nil {
			t.Errorf("gzip read error: %v", err)
		}
		data, err := io.ReadAll(r)
		if err != nil {
			t.Errorf("gzip read error: %v", err)
		}
		if string(data) != test.expected {
			t.Errorf("ReplaceGzip(%s, %s, %s): expected %v, actual %v", test.input, test.old, test.new, test.expected, writer.String())
		}
	}
}

func TestMaskBytes(t *testing.T) {
	var tests = []struct {
		input    []byte
		keywords [][]byte
		maskRune []byte
		expected []byte
	}{
		{[]byte("hello"), [][]byte{[]byte("l")}, []byte("*"), []byte("he**o")},
		{[]byte("hello"), [][]byte{[]byte("l")}, []byte(" "), []byte("he  o")},
		{[]byte("hello"), [][]byte{[]byte("l")}, []byte("a"), []byte("heaao")},
		{[]byte("hello"), [][]byte{[]byte("l")}, []byte("ä¸­"), []byte("heä¸­ä¸­o")},
		{[]byte("hello"), [][]byte{[]byte("l")}, []byte("ğŸ˜€"), []byte("heğŸ˜€ğŸ˜€o")},
		{[]byte("hello"), [][]byte{[]byte("l")}, []byte("ä¸­"), []byte("heä¸­ä¸­o")},
		{[]byte("hello"), [][]byte{[]byte("ll")}, []byte("ğŸ˜€"), []byte("heğŸ˜€ğŸ˜€o")},
		{[]byte("hello"), [][]byte{[]byte("he")}, []byte("ğŸ˜€"), []byte("ğŸ˜€ğŸ˜€llo")},
	}

	for _, test := range tests {
		result := stream.MaskBytes(test.input, test.keywords, test.maskRune)

		if !bytes.Equal(result, test.expected) {
			t.Errorf("MaskBytes(%s, %s, %v): expected %v, actual %v", test.input, test.keywords, test.maskRune, test.expected, test.input)
		}
	}
}

func TestMaskKeywords(t *testing.T) {
	var tests = []struct {
		input    string
		keywords [][]byte
		maskRune []byte
		expected string
	}{
		{"hello", [][]byte{[]byte("l")}, []byte("*"), "he**o"},
		{"hello", [][]byte{[]byte("l")}, []byte(" "), "he  o"},
		{"hello", [][]byte{[]byte("l")}, []byte("a"), "heaao"},
		{"hello", [][]byte{[]byte("l")}, []byte("ä¸­"), "heä¸­ä¸­o"},
		{"hello", [][]byte{[]byte("l")}, []byte("ğŸ˜€"), "heğŸ˜€ğŸ˜€o"},
		{"hello", [][]byte{[]byte("l")}, []byte("ä¸­"), "heä¸­ä¸­o"},
		{"hello", [][]byte{[]byte("ll")}, []byte("ğŸ˜€"), "heğŸ˜€ğŸ˜€o"},
		{"hello", [][]byte{[]byte("he")}, []byte("ğŸ˜€"), "ğŸ˜€ğŸ˜€llo"},
		{"hello", [][]byte{[]byte("he"), []byte("ll"), []byte("o")}, []byte("ğŸ˜€"), "ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€"},
	}

	for _, test := range tests {
		reader := strings.NewReader(test.input)
		writer := strings.Builder{}
		err := stream.MaskKeywords(reader, &writer, test.keywords, test.maskRune)
		if err != nil {
			t.Errorf("MaskKeywords(%s, %s, %v): expected %v, actual %v", test.input, test.keywords, test.maskRune, nil, err)
		}
		if writer.String() != test.expected {
			t.Errorf("MaskKeywords(%s, %s, %v): expected %v, actual %v", test.input, test.keywords, test.maskRune, test.expected, writer.String())
		}
	}
}
